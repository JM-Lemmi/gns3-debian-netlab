name: Release
on:
  push:

jobs:
  generate-iso:
    runs-on: ubuntu-latest
    container:
      image: debian
    env:
      PKG: "frr frr-doc nmap netcat-traditional telnet wget curl apache2 ca-certificates net-tools nftables iptables ebtables bind9 nginx dnsmasq ifupdown bind9-dnsutils isc-dhcp-client neovim"
    steps:
      - run: apt update && apt install -y apt-rdepends dpkg-dev genisoimage
      - run: apt download $(apt-rdepends $PKG|grep -v "^ "|grep --invert-match -e debconf-2.0 -e libblas.so.3 -e cron-daemon -e libaprutil1-dbd-freetds -e host)
      - run: dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz
      - run: genisoimage -lJR -o debian-netpkgs.iso .

      - uses: actions/upload-artifact@v4
        with:
          name: debian-netpkgs.iso
          path: debian-netpkgs.iso
          if-no-files-found: error
          compression-level: 0

  generate-gns3a:
    needs: generate-iso
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download debian-netpkgs.iso
        uses: actions/download-artifact@v4
        with:
          name: debian-netpkgs.iso
      - run: echo "PKGISOMD5=$(md5sum debian-netpkgs.iso)" >> $GITHUB_OUTPUT
      
      - run: sed -i 's/3192d003067cea87640e989d3933edff/${PKGISOMD5}/g' debian-jle.gns3a

      - uses: actions/upload-artifact@v4
        with:
          name: debian-jle.gns3a
          path: debian-jle.gns3a
          if-no-files-found: error
          compression-level: 0
